<!DOCTYPE html>
<html>
<head>
<meta charset="utf8">
<script src="machine.js"></script>
<script src="lexer.js"></script>
<script src="parser.js"></script>

<style>
input[type=button] { margin: 0.1ex 1ex; height: 1.5em; }
#dashboard { height: 1.7em; }
#dashboard * { float: right; }
#displays>* { float: right; }
#statusbar { clear: both; padding-top: 1em; }
.display { width: 13ex; }
.display *, .hex { font-family: monospace; }
</style>

</head>
<body>
<div id="dashboard">
<input type="button" value="Вывод" onclick="selectText('output')">
<input type="button" value="Ввод" onclick="selectText('input')">
<input type="button" value="Программа" onclick="selectText('source')">
</div>

<div id="displays">
<textarea id="text" cols="80" rows="20"></textarea>

<div class="display">Останов: <input type="checkbox" onclick="toggleBp(this.checked)">
<div id="bp">
</div>
</div>

<div class="display">Память:<br><input id="addr" type="button" value="0000" onclick="setAddr()"><div id="ram"></div></div>
<div class="display">Вызовы:<br><div id="cs"></div></div>
<div class="display">Операнды:<br><div id="os"></div></div>
</div>
<div id="statusbar">
Адрес: <button onclick="setIp()"><span class="hex control" id="ip">0000</span></button>
Код: <span class="hex" id="code"></span><br>
Шаг: <input id="step" type="checkbox">
<input type="button" value="Транслировать" onclick="translate()">
<input type="button" value="Загрузить" onclick="load()">
<input type="button" value="Сброс" onclick="reset()">
<input id="run" type="button" value="Пуск" onclick="run()">
</div>

<script>

var displays = {
	text: 'text',
	bp: 'bp',
	addr: 'addr',
	ram: 'ram',
	cs: 'cs',
	os: 'os',
	ip: 'ip',
	code: 'code',
	step: 'step',
	run: 'run'
}
for (var i in displays) displays[i] = document.getElementById(displays[i])

var isRunning = false
var currentText = 'source'
var source = ''
var program = null
var address = 0
var breakEnabled = false

var io = {
	input: '',
	output: '',
	pos: 0,

	read: function () {
		if (this.pos >= this.input.length) return null

		this.pos++
		return this.input.charAt(this.pos - 1)
	},

	write: function (value) {
		this.output += String.fromCharCode(value)
		if (currentText == 'output') displays.text.value = this.output
		return true
	}
}

var machine = new BackMachine(io, io)

function selectText(name) {
	var value = displays.text.value
	switch (currentText) {
		case 'source': source = value; break
		case 'input': io.input = value; break
		case 'output': io.output = value; break
	}

	currentText = name
	switch (name) {
		case 'source': value = source; break
		case 'input': value = io.input; break
		case 'output': value = io.output; break
	}
	displays.text.value = value
}

function reverseArray(value) {
	var len = value.length - 1
	var result = new Array(len + 1)
	for (var i = len >> 1; i >= 0; i--) {
		result[i] = value[len - i]
		result[len - i] = value[i]
	}
	return result
}

function toHex(value) {
	return ('000' + value.toString(16)).substr(-4)
}

function dumpHex(dom, values) {
	var hex = new Array(values.length)
	for (var i = hex.length - 1; i >= 0; i--) {
		hex[i] = toHex(values[i])
	}
	dom.innerHTML = hex.join('<br>\n')
}

function dumpCode() {
	var address = machine.ip
	displays.ip.innerHTML = toHex(address)

	var code = machine.getProgram(address, 64)
	var hex = new Array(16)
	for (var i = 0; i < 64; i++) {
		hex[i] = (code.charCodeAt(i) & 15).toString(16)
	}
	displays.code.innerHTML = hex.join('')
}

function dumpMemory() {
	displays.addr.value = toHex(address)
	dumpHex(displays.ram, machine.getMemory(address, 16))
}

function dumpOpStack() {
	dumpHex(displays.os, reverseArray(machine.operandStack.slice(-16)))
}

function dumpCallStack() {
	dumpHex(displays.cs, reverseArray(machine.callStack.slice(-16)))
}

function renderBreakPoints() {
	var result = []
	for (var i = 0, mask = 1; i < 16; i++, mask <<= 1) {
		var address = toHex(machine.breakPoints[i])
		var checked = (machine.breakFlags & mask ? ' checked="checked"' : '')
		result.push(
			'<input type="button" value="' + address +
			'" onclick="setBp(' + i + ')"><input type="checkbox"' + checked +
			' onclick="toggleBp(this.checked, ' + i + ')">'
		)
	}
	displays.bp.innerHTML = result.join('<br>\n')
}

function translate() {
	
}

function load() {
	if (isRunning) return

	if (currentText == 'source') source = displays.text.value
	machine.setProgram(machine.ip, source)
	dumpCode()
}

function reset() {
	isRunning = false
	machine.ip = 0
	machine.callStack = []
	machine.operandStack = []
	dumpCode()
	dumpCallStack()
	dumpOpStack()
}

function setIp() {
	if (isRunning) return

	var newIp = prompt('Новый IP (шестнадцатиричный):', toHex(machine.ip))
	if (!newIp) return

	machine.ip = parseInt(newIp, 16) & 0xffff
	dumpCode()
}

function toggleBp(flag, index) {
	if (index == undefined) breakEnabled = flag
	else machine.toggleBreakPoint(index, flag)
}

function setBp(index) {
	var newBp = prompt(
		'Новый адрес для точки останова ' + index + ' (шестнадцатиричный):',
		toHex(machine.breakPoints[index])
	)
	if (!newBp) return

	machine.setBreakPoint(index, parseInt(newBp, 16))
	renderBreakPoints()
}

function setAddr() {
	var newAddr = prompt('Новый адрес в памяти (шестнадцатиричный):', toHex(address))
	if (!newAddr) return

	address = newAddr
	dumpMemory()
}


function run() {

}


dumpCode()
dumpCallStack()
dumpOpStack()
dumpMemory()
renderBreakPoints()

</script>

</body>
</html>